/**
 * skylark-pdfjs-viewer - A version of video.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-pdfjs-display","./pdfjs_dev","./ui_utils","./pdf_rendering_queue","./viewer_compatibility"],function(t,e,i,s,n){const{approximateFraction:a,CSS_UNITS:r,DEFAULT_SCALE:o,getOutputScale:h,NullL10n:l,RendererType:d,roundToDivide:c,TextLayerMode:p}=i,{createPromiseCapability:g,RenderingCancelledException:u,SVGGraphics:y}=t,{RenderingStates:v}=s,{viewerCompatibilityParams:m}=n,L=m.maxCanvasPixels||16777216;return{PDFPageView:class{constructor(t){const e=t.container,i=t.defaultViewport;this.id=t.id,this.renderingId="page"+this.id,this.pdfPage=null,this.pageLabel=null,this.rotation=0,this.scale=t.scale||o,this.viewport=i,this.pdfPageRotate=i.rotation,this._optionalContentConfigPromise=t.optionalContentConfigPromise||null,this.hasRestrictedScaling=!1,this.textLayerMode=Number.isInteger(t.textLayerMode)?t.textLayerMode:p.ENABLE,this.imageResourcesPath=t.imageResourcesPath||"",this.renderInteractiveForms="boolean"!=typeof t.renderInteractiveForms||t.renderInteractiveForms,this.useOnlyCssZoom=t.useOnlyCssZoom||!1,this.maxCanvasPixels=t.maxCanvasPixels||L,this.eventBus=t.eventBus,this.renderingQueue=t.renderingQueue,this.textLayerFactory=t.textLayerFactory,this.annotationLayerFactory=t.annotationLayerFactory,this.renderer=t.renderer||d.CANVAS,this.enableWebGL=t.enableWebGL||!1,this.l10n=t.l10n||l,this.enableScripting=t.enableScripting||!1,this.paintTask=null,this.paintedViewportMap=new WeakMap,this.renderingState=v.INITIAL,this.resume=null,this._renderError=null,this.annotationLayer=null,this.textLayer=null,this.zoomLayer=null;const s=document.createElement("div");s.className="page",s.style.width=Math.floor(this.viewport.width)+"px",s.style.height=Math.floor(this.viewport.height)+"px",s.setAttribute("data-page-number",this.id),this.div=s,e.appendChild(s)}setPdfPage(t){this.pdfPage=t,this.pdfPageRotate=t.rotate;const e=(this.rotation+this.pdfPageRotate)%360;this.viewport=t.getViewport({scale:this.scale*r,rotation:e}),this.reset()}destroy(){this.reset(),this.pdfPage&&this.pdfPage.cleanup()}async _renderAnnotationLayer(){let t=null;try{await this.annotationLayer.render(this.viewport,"display")}catch(e){t=e}finally{this.eventBus.dispatch("annotationlayerrendered",{source:this,pageNumber:this.id,error:t})}}_resetZoomLayer(t=!1){if(!this.zoomLayer)return;const e=this.zoomLayer.firstChild;this.paintedViewportMap.delete(e),e.width=0,e.height=0,t&&this.zoomLayer.remove(),this.zoomLayer=null}reset(t=!1,e=!1){this.cancelRendering(e),this.renderingState=v.INITIAL;const i=this.div;i.style.width=Math.floor(this.viewport.width)+"px",i.style.height=Math.floor(this.viewport.height)+"px";const s=i.childNodes,n=t&&this.zoomLayer||null,a=e&&this.annotationLayer&&this.annotationLayer.div||null;for(let t=s.length-1;t>=0;t--){const e=s[t];n!==e&&a!==e&&i.removeChild(e)}i.removeAttribute("data-loaded"),a?this.annotationLayer.hide():this.annotationLayer&&(this.annotationLayer.cancel(),this.annotationLayer=null),n||(this.canvas&&(this.paintedViewportMap.delete(this.canvas),this.canvas.width=0,this.canvas.height=0,delete this.canvas),this._resetZoomLayer()),this.svg&&(this.paintedViewportMap.delete(this.svg),delete this.svg),this.loadingIconDiv=document.createElement("div"),this.loadingIconDiv.className="loadingIcon",i.appendChild(this.loadingIconDiv)}update(t,e,i=null){this.scale=t||this.scale,void 0!==e&&(this.rotation=e),i instanceof Promise&&(this._optionalContentConfigPromise=i);const s=(this.rotation+this.pdfPageRotate)%360;if(this.viewport=this.viewport.clone({scale:this.scale*r,rotation:s}),this.svg)return this.cssTransform(this.svg,!0),void this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!0,timestamp:performance.now(),error:this._renderError});let n=!1;if(this.canvas&&this.maxCanvasPixels>0){const t=this.outputScale;(Math.floor(this.viewport.width)*t.sx|0)*(Math.floor(this.viewport.height)*t.sy|0)>this.maxCanvasPixels&&(n=!0)}if(this.canvas){if(this.useOnlyCssZoom||this.hasRestrictedScaling&&n)return this.cssTransform(this.canvas,!0),void this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!0,timestamp:performance.now(),error:this._renderError});this.zoomLayer||this.canvas.hasAttribute("hidden")||(this.zoomLayer=this.canvas.parentNode,this.zoomLayer.style.position="absolute")}this.zoomLayer&&this.cssTransform(this.zoomLayer.firstChild),this.reset(!0,!0)}cancelRendering(t=!1){this.paintTask&&(this.paintTask.cancel(),this.paintTask=null),this.resume=null,this.textLayer&&(this.textLayer.cancel(),this.textLayer=null),!t&&this.annotationLayer&&(this.annotationLayer.cancel(),this.annotationLayer=null)}cssTransform(t,e=!1){const i=this.viewport.width,s=this.viewport.height,n=this.div;t.style.width=t.parentNode.style.width=n.style.width=Math.floor(i)+"px",t.style.height=t.parentNode.style.height=n.style.height=Math.floor(s)+"px";const a=this.viewport.rotation-this.paintedViewportMap.get(t).rotation,r=Math.abs(a);let o=1,h=1;if(90!==r&&270!==r||(o=s/i,h=i/s),t.style.transform=`rotate(${a}deg) scale(${o}, ${h})`,this.textLayer){const t=this.textLayer.viewport,e=this.viewport.rotation-t.rotation,s=Math.abs(e);let n=i/t.width;90!==s&&270!==s||(n=i/t.height);const a=this.textLayer.textLayerDiv;let r,o;switch(s){case 0:r=o=0;break;case 90:r=0,o="-"+a.style.height;break;case 180:r="-"+a.style.width,o="-"+a.style.height;break;case 270:r="-"+a.style.width,o=0;break;default:console.error("Bad rotation value.")}a.style.transform=`rotate(${s}deg) `+`scale(${n}) `+`translate(${r}, ${o})`,a.style.transformOrigin="0% 0%"}e&&this.annotationLayer&&this._renderAnnotationLayer()}get width(){return this.viewport.width}get height(){return this.viewport.height}getPagePoint(t,e){return this.viewport.convertToPdfPoint(t,e)}draw(){this.renderingState!==v.INITIAL&&(console.error("Must be in new state before drawing"),this.reset());const{div:t,pdfPage:e}=this;if(!e)return this.renderingState=v.FINISHED,this.loadingIconDiv&&(t.removeChild(this.loadingIconDiv),delete this.loadingIconDiv),Promise.reject(new Error("pdfPage is not loaded"));this.renderingState=v.RUNNING;const i=document.createElement("div");i.style.width=t.style.width,i.style.height=t.style.height,i.classList.add("canvasWrapper"),this.annotationLayer&&this.annotationLayer.div?t.insertBefore(i,this.annotationLayer.div):t.appendChild(i);let s=null;if(this.textLayerMode!==p.DISABLE&&this.textLayerFactory){const e=document.createElement("div");e.className="textLayer",e.style.width=i.style.width,e.style.height=i.style.height,this.annotationLayer&&this.annotationLayer.div?t.insertBefore(e,this.annotationLayer.div):t.appendChild(e),s=this.textLayerFactory.createTextLayerBuilder(e,this.id-1,this.viewport,this.textLayerMode===p.ENABLE_ENHANCE,this.eventBus)}this.textLayer=s;let n=null;this.renderingQueue&&(n=(t=>{if(!this.renderingQueue.isHighestPriority(this))return this.renderingState=v.PAUSED,void(this.resume=(()=>{this.renderingState=v.RUNNING,t()}));t()}));const a=async(e=null)=>{if(r===this.paintTask&&(this.paintTask=null),e instanceof u)this._renderError=null;else if(this._renderError=e,this.renderingState=v.FINISHED,this.loadingIconDiv&&(t.removeChild(this.loadingIconDiv),delete this.loadingIconDiv),this._resetZoomLayer(!0),this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!1,timestamp:performance.now(),error:this._renderError}),e)throw e},r=this.renderer===d.SVG?this.paintOnSvg(i):this.paintOnCanvas(i);r.onRenderContinue=n,this.paintTask=r;const o=r.promise.then(function(){return a(null).then(function(){if(s){const t=e.streamTextContent({normalizeWhitespace:!0});s.setTextContentStream(t),s.render()}})},function(t){return a(t)});return this.annotationLayerFactory&&(this.annotationLayer||(this.annotationLayer=this.annotationLayerFactory.createAnnotationLayerBuilder(t,e,null,this.imageResourcesPath,this.renderInteractiveForms,this.l10n,this.enableScripting,null,null)),this._renderAnnotationLayer()),t.setAttribute("data-loaded",!0),this.eventBus.dispatch("pagerender",{source:this,pageNumber:this.id}),o}paintOnCanvas(t){const i=g(),s={promise:i.promise,onRenderContinue(t){t()},cancel(){L.cancel()}},n=this.viewport,o=document.createElement("canvas");this.l10n.get("page_canvas",{page:this.id},"Page {{page}}").then(t=>{o.setAttribute("aria-label",t)}),o.setAttribute("hidden","hidden");let l=!0;const d=function(){l&&(o.removeAttribute("hidden"),l=!1)};t.appendChild(o),this.canvas=o,(void 0===e||e.test("MOZCENTRAL || GENERIC"))&&(o.mozOpaque=!0);const p=o.getContext("2d",{alpha:!1}),u=h(p);if(this.outputScale=u,this.useOnlyCssZoom){const t=n.clone({scale:r});u.sx*=t.width/n.width,u.sy*=t.height/n.height,u.scaled=!0}if(this.maxCanvasPixels>0){const t=n.width*n.height,e=Math.sqrt(this.maxCanvasPixels/t);u.sx>e||u.sy>e?(u.sx=e,u.sy=e,u.scaled=!0,this.hasRestrictedScaling=!0):this.hasRestrictedScaling=!1}const y=a(u.sx),v=a(u.sy);o.width=c(n.width*u.sx,y[0]),o.height=c(n.height*u.sy,v[0]),o.style.width=c(n.width,y[1])+"px",o.style.height=c(n.height,v[1])+"px",this.paintedViewportMap.set(o,n);const m={canvasContext:p,transform:u.scaled?[u.sx,0,0,u.sy,0,0]:null,viewport:this.viewport,enableWebGL:this.enableWebGL,renderInteractiveForms:this.renderInteractiveForms,optionalContentConfigPromise:this._optionalContentConfigPromise},L=this.pdfPage.render(m);return L.onContinue=function(t){d(),s.onRenderContinue?s.onRenderContinue(t):t()},L.promise.then(function(){d(),i.resolve(void 0)},function(t){d(),i.reject(t)}),s}paintOnSvg(t){if(void 0!==e&&e.test("MOZCENTRAL || CHROME"))return{promise:Promise.reject(new Error("SVG rendering is not supported.")),onRenderContinue(t){},cancel(){}};let i=!1;const s=()=>{if(i)throw new u(`Rendering cancelled, page ${this.id}`,"svg")},n=this.pdfPage,a=this.viewport.clone({scale:r});return{promise:n.getOperatorList().then(e=>(s(),new y(n.commonObjs,n.objs).getSVG(e,a).then(e=>{s(),this.svg=e,this.paintedViewportMap.set(e,a),e.style.width=t.style.width,e.style.height=t.style.height,this.renderingState=v.FINISHED,t.appendChild(e)}))),onRenderContinue(t){t()},cancel(){i=!0}}}setPageLabel(t){this.pageLabel="string"==typeof t?t:null,null!==this.pageLabel?this.div.setAttribute("data-page-label",this.pageLabel):this.div.removeAttribute("data-page-label")}}}});
//# sourceMappingURL=sourcemaps/pdf_page_view.js.map
