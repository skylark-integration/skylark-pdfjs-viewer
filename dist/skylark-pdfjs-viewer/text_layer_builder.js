/**
 * skylark-pdfjs-viewer - A version of video.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-pdfjs-display","./pdfjs_dev"],function(e,t){const{renderTextLayer:n}=e,s=300;class i{constructor({textLayerDiv:e,eventBus:t,pageIndex:n,viewport:s,findController:i=null,enhanceTextSelection:a=!1}){this.textLayerDiv=e,this.eventBus=t,this.textContent=null,this.textContentItemsStr=[],this.textContentStream=null,this.renderingDone=!1,this.pageIdx=n,this.pageNumber=this.pageIdx+1,this.matches=[],this.viewport=s,this.textDivs=[],this.findController=i,this.textLayerRenderTask=null,this.enhanceTextSelection=a,this._onUpdateTextLayerMatches=null,this._bindMouse()}_finishRendering(){if(this.renderingDone=!0,!this.enhanceTextSelection){const e=document.createElement("div");e.className="endOfContent",this.textLayerDiv.appendChild(e)}this.eventBus.dispatch("textlayerrendered",{source:this,pageNumber:this.pageNumber,numTextDivs:this.textDivs.length})}render(e=0){if(!this.textContent&&!this.textContentStream||this.renderingDone)return;this.cancel(),this.textDivs=[];const t=document.createDocumentFragment();this.textLayerRenderTask=n({textContent:this.textContent,textContentStream:this.textContentStream,container:t,viewport:this.viewport,textDivs:this.textDivs,textContentItemsStr:this.textContentItemsStr,timeout:e,enhanceTextSelection:this.enhanceTextSelection}),this.textLayerRenderTask.promise.then(()=>{this.textLayerDiv.appendChild(t),this._finishRendering(),this._updateMatches()},function(e){}),this._onUpdateTextLayerMatches||(this._onUpdateTextLayerMatches=(e=>{e.pageIndex!==this.pageIdx&&-1!==e.pageIndex||this._updateMatches()}),this.eventBus._on("updatetextlayermatches",this._onUpdateTextLayerMatches))}cancel(){this.textLayerRenderTask&&(this.textLayerRenderTask.cancel(),this.textLayerRenderTask=null),this._onUpdateTextLayerMatches&&(this.eventBus._off("updatetextlayermatches",this._onUpdateTextLayerMatches),this._onUpdateTextLayerMatches=null)}setTextContentStream(e){this.cancel(),this.textContentStream=e}setTextContent(e){this.cancel(),this.textContent=e}_convertMatches(e,t){if(!e)return[];const{textContentItemsStr:n}=this;let s=0,i=0;const a=n.length-1,r=[];for(let d=0,h=e.length;d<h;d++){let h=e[d];for(;s!==a&&h>=i+n[s].length;)i+=n[s].length,s++;s===n.length&&console.error("Could not find a matching mapping");const o={begin:{divIdx:s,offset:h-i}};for(h+=t[d];s!==a&&h>i+n[s].length;)i+=n[s].length,s++;o.end={divIdx:s,offset:h-i},r.push(o)}return r}_renderMatches(e){if(0===e.length)return;const{findController:t,pageIdx:n,textContentItemsStr:s,textDivs:i}=this,a=n===t.selected.pageIdx,r=t.selected.matchIdx;let d=null;const h={divIdx:-1,offset:void 0};function o(e,t){const n=e.divIdx;i[n].textContent="",l(n,0,e.offset,t)}function l(e,t,n,a){const r=i[e],d=s[e].substring(t,n),h=document.createTextNode(d);if(a){const e=document.createElement("span");return e.className=a,e.appendChild(h),void r.appendChild(e)}r.appendChild(h)}let c=r,x=c+1;if(t.state.highlightAll)c=0,x=e.length;else if(!a)return;for(let s=c;s<x;s++){const c=e[s],x=c.begin,u=c.end,f=a&&s===r,v=f?" selected":"";if(f&&t.scrollMatchIntoView({element:i[x.divIdx],pageIndex:n,matchIndex:r}),d&&x.divIdx===d.divIdx?l(d.divIdx,d.offset,x.offset):(null!==d&&l(d.divIdx,d.offset,h.offset),o(x)),x.divIdx===u.divIdx)l(x.divIdx,x.offset,u.offset,"highlight"+v);else{l(x.divIdx,x.offset,h.offset,"highlight begin"+v);for(let e=x.divIdx+1,t=u.divIdx;e<t;e++)i[e].className="highlight middle"+v;o(u,"highlight end"+v)}d=u}d&&l(d.divIdx,d.offset,h.offset)}_updateMatches(){if(!this.renderingDone)return;const{findController:e,matches:t,pageIdx:n,textContentItemsStr:s,textDivs:i}=this;let a=-1;for(let e=0,n=t.length;e<n;e++){const n=t[e];for(let e=Math.max(a,n.begin.divIdx),t=n.end.divIdx;e<=t;e++){const t=i[e];t.textContent=s[e],t.className=""}a=n.end.divIdx+1}if(!e||!e.highlightMatches)return;const r=e.pageMatches[n]||null,d=e.pageMatchesLength[n]||null;this.matches=this._convertMatches(r,d),this._renderMatches(this.matches)}_bindMouse(){const e=this.textLayerDiv;let n=null;e.addEventListener("mousedown",s=>{if(this.enhanceTextSelection&&this.textLayerRenderTask)return this.textLayerRenderTask.expandTextDivs(!0),void(void 0!==t&&t.test("MOZCENTRAL")||!n||(clearTimeout(n),n=null));const i=e.querySelector(".endOfContent");if(i){if(void 0===t||!t.test("MOZCENTRAL")){let n=s.target!==e;if((void 0===t||t.test("GENERIC"))&&(n=n&&"none"!==window.getComputedStyle(i).getPropertyValue("-moz-user-select")),n){const t=e.getBoundingClientRect(),n=Math.max(0,(s.pageY-t.top)/t.height);i.style.top=(100*n).toFixed(2)+"%"}}i.classList.add("active")}}),e.addEventListener("mouseup",()=>{if(this.enhanceTextSelection&&this.textLayerRenderTask)return void(void 0!==t&&t.test("MOZCENTRAL")?this.textLayerRenderTask.expandTextDivs(!1):n=setTimeout(()=>{this.textLayerRenderTask&&this.textLayerRenderTask.expandTextDivs(!1),n=null},s));const i=e.querySelector(".endOfContent");i&&(void 0!==t&&t.test("MOZCENTRAL")||(i.style.top=""),i.classList.remove("active"))})}}return{DefaultTextLayerFactory:class{createTextLayerBuilder(e,t,n,s=!1,a){return new i({textLayerDiv:e,pageIndex:t,viewport:n,enhanceTextSelection:s,eventBus:a})}},TextLayerBuilder:i}});
//# sourceMappingURL=sourcemaps/text_layer_builder.js.map
