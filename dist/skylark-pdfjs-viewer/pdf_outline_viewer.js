/**
 * skylark-pdfjs-viewer - A version of video.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-pdfjs-display","./ui_utils","./base_tree_viewer"],function(e,t,i){const{addLinkAttributes:s,createPromiseCapability:n,LinkTarget:r}=e,{BaseTreeViewer:a}=i,{SidebarView:o}=t;return{PDFOutlineViewer:class extends a{constructor(e){super(e),this.linkService=e.linkService,this.eventBus._on("toggleoutlinetree",this._toggleAllTreeItems.bind(this)),this.eventBus._on("currentoutlineitem",this._currentOutlineItem.bind(this)),this.eventBus._on("pagechanging",e=>{this._currentPageNumber=e.pageNumber}),this.eventBus._on("pagesloaded",e=>{this._isPagesLoaded=!!e.pagesCount}),this.eventBus._on("sidebarviewchanged",e=>{this._sidebarView=e.view})}reset(){super.reset(),this._outline=null,this._pageNumberToDestHashCapability=null,this._currentPageNumber=1,this._isPagesLoaded=!1}_dispatchEvent(e){this.eventBus.dispatch("outlineloaded",{source:this,outlineCount:e,enableCurrentOutlineItemButton:e>0&&!(this._pdfDocument&&this._pdfDocument.loadingParams.disableAutoFetch)})}_bindLink(e,{url:t,newWindow:i,dest:n}){const{linkService:a}=this;t?s(e,{url:t,target:i?r.BLANK:a.externalLinkTarget,rel:a.externalLinkRel,enabled:a.externalLinkEnabled}):(e.href=a.getDestinationHash(n),e.onclick=(e=>(this._updateCurrentTreeItem(e.target.parentNode),n&&a.goToDestination(n),!1)))}_setStyles(e,{bold:t,italic:i}){t&&(e.style.fontWeight="bold"),i&&(e.style.fontStyle="italic")}_addToggleButton(e,{count:t,items:i}){let s=!1;if(t<0){let e=i.length;if(e>0){const t=[...i];for(;t.length>0;){const{count:i,items:s}=t.shift();i>0&&s.length>0&&(e+=s.length,t.push(...s))}}Math.abs(t)===e&&(s=!0)}super._addToggleButton(e,s)}_toggleAllTreeItems(){this._outline&&super._toggleAllTreeItems()}render({outline:e,pdfDocument:t}){if(this._outline&&this.reset(),this._outline=e||null,this._pdfDocument=t||null,!e)return void this._dispatchEvent(0);const i=document.createDocumentFragment(),s=[{parent:i,items:e}];let n=0,r=!1;for(;s.length>0;){const e=s.shift();for(const t of e.items){const i=document.createElement("div");i.className="treeItem";const a=document.createElement("a");if(this._bindLink(a,t),this._setStyles(a,t),a.textContent=this._normalizeTextContent(t.title),i.appendChild(a),t.items.length>0){r=!0,this._addToggleButton(i,t);const e=document.createElement("div");e.className="treeItems",i.appendChild(e),s.push({parent:e,items:t.items})}e.parent.appendChild(i),n++}}this._finishRendering(i,n,r)}async _currentOutlineItem(){if(!this._isPagesLoaded)throw new Error("_currentOutlineItem: All pages have not been loaded.");if(!this._outline||!this._pdfDocument)return;const e=await this._getPageNumberToDestHash(this._pdfDocument);if(e&&(this._updateCurrentTreeItem(null),this._sidebarView===o.OUTLINE))for(let t=this._currentPageNumber;t>0;t--){const i=e.get(t);if(!i)continue;const s=this.container.querySelector(`a[href="${i}"]`);if(s){this._scrollToCurrentTreeItem(s.parentNode);break}}}async _getPageNumberToDestHash(e){if(this._pageNumberToDestHashCapability)return this._pageNumberToDestHashCapability.promise;this._pageNumberToDestHashCapability=n();const t=new Map,i=new Map,s=[{nesting:0,items:this._outline}];for(;s.length>0;){const n=s.shift(),r=n.nesting;for(const{dest:a,items:o}of n.items){let n,l;if("string"==typeof a){if(n=await e.getDestination(a),e!==this._pdfDocument)return null}else n=a;if(Array.isArray(n)){const[s]=n;if("object"==typeof s){if(!(l=this.linkService._cachedPageNumber(s)))try{if(l=await e.getPageIndex(s)+1,e!==this._pdfDocument)return null;this.linkService.cachePageRef(l,s)}catch(e){}}else Number.isInteger(s)&&(l=s+1);if(Number.isInteger(l)&&(!t.has(l)||r>i.get(l))){const e=this.linkService.getDestinationHash(a);t.set(l,e),i.set(l,r)}}o.length>0&&s.push({nesting:r+1,items:o})}}return this._pageNumberToDestHashCapability.resolve(t.size>0?t:null),this._pageNumberToDestHashCapability.promise}}}});
//# sourceMappingURL=sourcemaps/pdf_outline_viewer.js.map
