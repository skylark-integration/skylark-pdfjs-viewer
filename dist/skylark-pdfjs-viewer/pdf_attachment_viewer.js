/**
 * skylark-pdfjs-viewer - A version of video.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-pdfjs-display","./pdfjs_dev","./base_tree_viewer","./viewer_compatibility"],function(e,t,n,i){const{createPromiseCapability:a,getFilenameFromUrl:s}=e,{BaseTreeViewer:o}=n,{viewerCompatibilityParams:c}=i,r=/\.pdf$/i;return{PDFAttachmentViewer:class extends o{constructor(e){super(e),this.downloadManager=e.downloadManager,this.eventBus._on("fileattachmentannotation",this._appendAttachment.bind(this))}reset(e=!1){super.reset(),this._attachments=null,e||(this._renderedCapability=a()),this._pendingDispatchEvent&&clearTimeout(this._pendingDispatchEvent),this._pendingDispatchEvent=null}_dispatchEvent(e){this._renderedCapability.resolve(),this._pendingDispatchEvent&&(clearTimeout(this._pendingDispatchEvent),this._pendingDispatchEvent=null),0!==e?this.eventBus.dispatch("attachmentsloaded",{source:this,attachmentsCount:e}):this._pendingDispatchEvent=setTimeout(()=>{this.eventBus.dispatch("attachmentsloaded",{source:this,attachmentsCount:0}),this._pendingDispatchEvent=null})}_bindPdfLink(e,{content:n,filename:i}){let a;e.onclick=(()=>{let e;a||(a=URL.createObjectURL(new Blob([n],{type:"application/pdf"}))),void 0===t||t.test("GENERIC")?e="?file="+encodeURIComponent(a+"#"+i):t.test("MOZCENTRAL")?e=a+"#filename="+encodeURIComponent(i):t.test("CHROME")&&(e=chrome.runtime.getURL("/content/web/viewer.html")+"?file="+encodeURIComponent(a+"#"+i));try{window.open(e)}catch(e){console.error(`_bindPdfLink: ${e}`),URL.revokeObjectURL(a),a=null,this.downloadManager.downloadData(n,i,"application/pdf")}return!1})}_bindLink(e,{content:t,filename:n}){e.onclick=(()=>{const e=r.test(n)?"application/pdf":"";return this.downloadManager.downloadData(t,n,e),!1})}render({attachments:e,keepRenderedCapability:t=!1}){if(this._attachments&&this.reset(t),this._attachments=e||null,!e)return void this._dispatchEvent(0);const n=Object.keys(e).sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())}),i=document.createDocumentFragment();let a=0;for(const t of n){const n=e[t],o=s(n.filename),d=document.createElement("div");d.className="treeItem";const l=document.createElement("a");r.test(o)&&!c.disableCreateObjectURL?this._bindPdfLink(l,{content:n.content,filename:o}):this._bindLink(l,{content:n.content,filename:o}),l.textContent=this._normalizeTextContent(o),d.appendChild(l),i.appendChild(d),a++}this._finishRendering(i,a)}_appendAttachment({id:e,filename:t,content:n}){const i=this._renderedCapability.promise;i.then(()=>{if(i!==this._renderedCapability.promise)return;let a=this._attachments;if(a){for(const t in a)if(e===t)return}else a=Object.create(null);a[e]={filename:t,content:n},this.render({attachments:a,keepRenderedCapability:!0})})}}}});
//# sourceMappingURL=sourcemaps/pdf_attachment_viewer.js.map
