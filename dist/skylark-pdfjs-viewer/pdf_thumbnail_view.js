/**
 * skylark-pdfjs-viewer - A version of video.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-pdfjs-display","./pdfjs_dev","./ui_utils","./pdf_rendering_queue"],function(t,e,i,a){const{getOutputScale:s,NullL10n:n}=i,{RenderingCancelledException:h}=t,{RenderingStates:r}=a,o=3,d=1,g=98,l=function(){let t=null;return{getCanvas(i,a){let s=t;s||(s=document.createElement("canvas"),t=s),s.width=i,s.height=a,(void 0===e||e.test("MOZCENTRAL || GENERIC"))&&(s.mozOpaque=!0);const n=s.getContext("2d",{alpha:!1});return n.save(),n.fillStyle="rgb(255, 255, 255)",n.fillRect(0,0,i,a),n.restore(),s},destroyCanvas(){const e=t;e&&(e.width=0,e.height=0),t=null}}}();return{PDFThumbnailView:class{constructor({container:t,id:e,defaultViewport:i,optionalContentConfigPromise:a,linkService:s,renderingQueue:h,checkSetImageDisabled:o,disableCanvasToImageConversion:l=!1,l10n:c=n}){this.id=e,this.renderingId="thumbnail"+e,this.pageLabel=null,this.pdfPage=null,this.rotation=0,this.viewport=i,this.pdfPageRotate=i.rotation,this._optionalContentConfigPromise=a||null,this.linkService=s,this.renderingQueue=h,this.renderTask=null,this.renderingState=r.INITIAL,this.resume=null,this._checkSetImageDisabled=o||function(){return!1},this.disableCanvasToImageConversion=l,this.pageWidth=this.viewport.width,this.pageHeight=this.viewport.height,this.pageRatio=this.pageWidth/this.pageHeight,this.canvasWidth=g,this.canvasHeight=this.canvasWidth/this.pageRatio|0,this.scale=this.canvasWidth/this.pageWidth,this.l10n=c;const u=document.createElement("a");u.href=s.getAnchorUrl("#page="+e),this._thumbPageTitle.then(t=>{u.title=t}),u.onclick=function(){return s.goToPage(e),!1},this.anchor=u;const v=document.createElement("div");v.className="thumbnail",v.setAttribute("data-page-number",this.id),this.div=v;const p=document.createElement("div");p.className="thumbnailSelectionRing";const m=2*d;p.style.width=this.canvasWidth+m+"px",p.style.height=this.canvasHeight+m+"px",this.ring=p,v.appendChild(p),u.appendChild(v),t.appendChild(u)}setPdfPage(t){this.pdfPage=t,this.pdfPageRotate=t.rotate;const e=(this.rotation+this.pdfPageRotate)%360;this.viewport=t.getViewport({scale:1,rotation:e}),this.reset()}reset(){this.cancelRendering(),this.renderingState=r.INITIAL,this.pageWidth=this.viewport.width,this.pageHeight=this.viewport.height,this.pageRatio=this.pageWidth/this.pageHeight,this.canvasHeight=this.canvasWidth/this.pageRatio|0,this.scale=this.canvasWidth/this.pageWidth,this.div.removeAttribute("data-loaded");const t=this.ring,e=t.childNodes;for(let i=e.length-1;i>=0;i--)t.removeChild(e[i]);const i=2*d;t.style.width=this.canvasWidth+i+"px",t.style.height=this.canvasHeight+i+"px",this.canvas&&(this.canvas.width=0,this.canvas.height=0,delete this.canvas),this.image&&(this.image.removeAttribute("src"),delete this.image)}update(t){void 0!==t&&(this.rotation=t);const e=(this.rotation+this.pdfPageRotate)%360;this.viewport=this.viewport.clone({scale:1,rotation:e}),this.reset()}cancelRendering(){this.renderTask&&(this.renderTask.cancel(),this.renderTask=null),this.resume=null}_getPageDrawContext(){const t=document.createElement("canvas");this.canvas=t,(void 0===e||e.test("MOZCENTRAL || GENERIC"))&&(t.mozOpaque=!0);const i=t.getContext("2d",{alpha:!1}),a=s(i);return t.width=this.canvasWidth*a.sx|0,t.height=this.canvasHeight*a.sy|0,t.style.width=this.canvasWidth+"px",t.style.height=this.canvasHeight+"px",[i,a.scaled?[a.sx,0,0,a.sy,0,0]:null]}_convertCanvasToImage(){if(!this.canvas)return;if(this.renderingState!==r.FINISHED)return;if(this.disableCanvasToImageConversion)return this.canvas.className="thumbnailImage",this._thumbPageCanvas.then(t=>{this.canvas.setAttribute("aria-label",t)}),this.div.setAttribute("data-loaded",!0),void this.ring.appendChild(this.canvas);const t=document.createElement("img");t.className="thumbnailImage",this._thumbPageCanvas.then(e=>{t.setAttribute("aria-label",e)}),t.style.width=this.canvasWidth+"px",t.style.height=this.canvasHeight+"px",t.src=this.canvas.toDataURL(),this.image=t,this.div.setAttribute("data-loaded",!0),this.ring.appendChild(t),this.canvas.width=0,this.canvas.height=0,delete this.canvas}draw(){if(this.renderingState!==r.INITIAL)return console.error("Must be in new state before drawing"),Promise.resolve(void 0);const{pdfPage:t}=this;if(!t)return this.renderingState=r.FINISHED,Promise.reject(new Error("pdfPage is not loaded"));this.renderingState=r.RUNNING;const e=async(t=null)=>{if(n===this.renderTask&&(this.renderTask=null),!(t instanceof h)&&(this.renderingState=r.FINISHED,this._convertCanvasToImage(),t))throw t},[i,a]=this._getPageDrawContext(),s={canvasContext:i,transform:a,viewport:this.viewport.clone({scale:this.scale}),optionalContentConfigPromise:this._optionalContentConfigPromise},n=this.renderTask=t.render(s);n.onContinue=(t=>{if(!this.renderingQueue.isHighestPriority(this))return this.renderingState=r.PAUSED,void(this.resume=(()=>{this.renderingState=r.RUNNING,t()}));t()});const o=n.promise.then(function(){e(null)},function(t){e(t)});return o.finally(()=>{this.linkService.isPageCached(this.id)||this.pdfPage&&this.pdfPage.cleanup()}),o}setImage(t){if(this._checkSetImageDisabled())return;if(this.renderingState!==r.INITIAL)return;const e=t.canvas;if(!e)return;this.pdfPage||this.setPdfPage(t.pdfPage),this.renderingState=r.FINISHED;const[i]=this._getPageDrawContext(),a=i.canvas;if(e.width<=2*a.width)return i.drawImage(e,0,0,e.width,e.height,0,0,a.width,a.height),void this._convertCanvasToImage();let s=a.width<<o,n=a.height<<o;const h=l.getCanvas(s,n),d=h.getContext("2d");for(;s>e.width||n>e.height;)s>>=1,n>>=1;for(d.drawImage(e,0,0,e.width,e.height,0,0,s,n);s>2*a.width;)d.drawImage(h,0,0,s,n,0,0,s>>1,n>>1),s>>=1,n>>=1;i.drawImage(h,0,0,s,n,0,0,a.width,a.height),this._convertCanvasToImage()}get _thumbPageTitle(){return this.l10n.get("thumb_page_title",{page:this.pageLabel&&this.id},"Page {{page}}")}get _thumbPageCanvas(){return this.l10n.get("thumb_page_canvas",{page:this.pageLabel&&this.id},"Thumbnail of Page {{page}}")}setPageLabel(t){this.pageLabel="string"==typeof t?t:null,this._thumbPageTitle.then(t=>{this.anchor.title=t}),this.renderingState===r.FINISHED&&this._thumbPageCanvas.then(t=>{this.image?this.image.setAttribute("aria-label",t):this.disableCanvasToImageConversion&&this.canvas&&this.canvas.setAttribute("aria-label",t)})}},TempImageFactory:l}});
//# sourceMappingURL=sourcemaps/pdf_thumbnail_view.js.map
