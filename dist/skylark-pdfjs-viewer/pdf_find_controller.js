/**
 * skylark-pdfjs-viewer - A version of video.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-pdfjs-display","./ui_utils","./pdf_find_utils"],function(t,e,s){const{createPromiseCapability:h}=t,{getCharacterType:i}=s,{scrollIntoView:a}=e,n={FOUND:0,NOT_FOUND:1,WRAPPED:2,PENDING:3},c=250,r=-50,l=-400,_={"‘":"'","’":"'","‚":"'","‛":"'","“":'"',"”":'"',"„":'"',"‟":'"',"¼":"1/4","½":"1/2","¾":"3/4"};let o=null;function u(t){if(!o){const t=Object.keys(_).join("");o=new RegExp(`[${t}]`,"g")}let e=null;return[t.replace(o,function(t,s){const h=_[t],i=h.length-t.length;return 0!==i&&(e||(e=[])).push([s,i]),h}),e]}function d(t,e=null){if(!e)return t;let s=0;for(const[h,i]of e){const e=h+s;if(e>=t)break;if(e+i>t){s+=t-e;break}s+=i}return t-s}return{FindState:n,PDFFindController:class{constructor({linkService:t,eventBus:e}){this._linkService=t,this._eventBus=e,this._reset(),e._on("findbarclose",this._onFindBarClose.bind(this))}get highlightMatches(){return this._highlightMatches}get pageMatches(){return this._pageMatches}get pageMatchesLength(){return this._pageMatchesLength}get selected(){return this._selected}get state(){return this._state}setDocument(t){this._pdfDocument&&this._reset(),t&&(this._pdfDocument=t,this._firstPageCapability.resolve())}executeCommand(t,e){if(!e)return;const s=this._pdfDocument;(null===this._state||this._shouldDirtyMatch(t,e))&&(this._dirtyMatch=!0),this._state=e,"findhighlightallchange"!==t&&this._updateUIState(n.PENDING),this._firstPageCapability.promise.then(()=>{if(!this._pdfDocument||s&&this._pdfDocument!==s)return;this._extractText();const e=!this._highlightMatches,h=!!this._findTimeout;this._findTimeout&&(clearTimeout(this._findTimeout),this._findTimeout=null),"find"===t?this._findTimeout=setTimeout(()=>{this._nextMatch(),this._findTimeout=null},c):this._dirtyMatch?this._nextMatch():"findagain"===t?(this._nextMatch(),e&&this._state.highlightAll&&this._updateAllPages()):"findhighlightallchange"===t?(h?this._nextMatch():this._highlightMatches=!0,this._updateAllPages()):this._nextMatch()})}scrollMatchIntoView({element:t=null,pageIndex:e=-1,matchIndex:s=-1}){this._scrollMatches&&t&&-1!==s&&s===this._selected.matchIdx&&-1!==e&&e===this._selected.pageIdx&&(this._scrollMatches=!1,a(t,{top:r,left:l},!0))}_reset(){this._highlightMatches=!1,this._scrollMatches=!1,this._pdfDocument=null,this._pageMatches=[],this._pageMatchesLength=[],this._state=null,this._selected={pageIdx:-1,matchIdx:-1},this._offset={pageIdx:null,matchIdx:null,wrapped:!1},this._extractTextPromises=[],this._pageContents=[],this._pageDiffs=[],this._matchesCountTotal=0,this._pagesToSearch=null,this._pendingFindMatches=Object.create(null),this._resumePageIdx=null,this._dirtyMatch=!1,clearTimeout(this._findTimeout),this._findTimeout=null,this._firstPageCapability=h()}get _query(){return this._state.query!==this._rawQuery&&(this._rawQuery=this._state.query,[this._normalizedQuery]=u(this._state.query)),this._normalizedQuery}_shouldDirtyMatch(t,e){if(e.query!==this._state.query)return!0;switch(t){case"findagain":const e=this._selected.pageIdx+1,s=this._linkService;return e>=1&&e<=s.pagesCount&&e!==s.page&&!s.isPageVisible(e);case"findhighlightallchange":return!1}return!0}_prepareMatches(t,e,s){function h(e){const s=t[e],h=t[e+1];if(e<t.length-1&&s.match===h.match)return s.skipped=!0,!0;for(let h=e-1;h>=0;h--){const e=t[h];if(!e.skipped){if(e.match+e.matchLength<s.match)break;if(e.match+e.matchLength>=s.match+s.matchLength)return s.skipped=!0,!0}}return!1}t.sort(function(t,e){return t.match===e.match?t.matchLength-e.matchLength:t.match-e.match});for(let i=0,a=t.length;i<a;i++)h(i)||(e.push(t[i].match),s.push(t[i].matchLength))}_isEntireWord(t,e,s){if(e>0){const s=t.charCodeAt(e),h=t.charCodeAt(e-1);if(i(s)===i(h))return!1}const h=e+s-1;if(h<t.length-1){const e=t.charCodeAt(h),s=t.charCodeAt(h+1);if(i(e)===i(s))return!1}return!0}_calculatePhraseMatch(t,e,s,h,i){const a=[],n=[],c=t.length;let r=-c;for(;-1!==(r=s.indexOf(t,r+c));){if(i&&!this._isEntireWord(s,r,c))continue;const t=d(r,h),e=d(r+c-1,h)-t+1;a.push(t),n.push(e)}this._pageMatches[e]=a,this._pageMatchesLength[e]=n}_calculateWordMatch(t,e,s,h,i){const a=[],n=t.match(/\S+/g);for(let t=0,e=n.length;t<e;t++){const e=n[t],c=e.length;let r=-c;for(;-1!==(r=s.indexOf(e,r+c));){if(i&&!this._isEntireWord(s,r,c))continue;const t=d(r,h),e=d(r+c-1,h)-t+1;a.push({match:t,matchLength:e,skipped:!1})}}this._pageMatchesLength[e]=[],this._pageMatches[e]=[],this._prepareMatches(a,this._pageMatches[e],this._pageMatchesLength[e])}_calculateMatch(t){let e=this._pageContents[t];const s=this._pageDiffs[t];let h=this._query;const{caseSensitive:i,entireWord:a,phraseSearch:n}=this._state;if(0===h.length)return;i||(e=e.toLowerCase(),h=h.toLowerCase()),n?this._calculatePhraseMatch(h,t,e,s,a):this._calculateWordMatch(h,t,e,s,a),this._state.highlightAll&&this._updatePage(t),this._resumePageIdx===t&&(this._resumePageIdx=null,this._nextPageMatch());const c=this._pageMatches[t].length;c>0&&(this._matchesCountTotal+=c,this._updateUIResultsCount())}_extractText(){if(this._extractTextPromises.length>0)return;let t=Promise.resolve();for(let e=0,s=this._linkService.pagesCount;e<s;e++){const s=h();this._extractTextPromises[e]=s.promise,t=t.then(()=>this._pdfDocument.getPage(e+1).then(t=>t.getTextContent({normalizeWhitespace:!0})).then(t=>{const h=t.items,i=[];for(let t=0,e=h.length;t<e;t++)i.push(h[t].str);[this._pageContents[e],this._pageDiffs[e]]=u(i.join("")),s.resolve(e)},t=>{console.error(`Unable to get text content for page ${e+1}`,t),this._pageContents[e]="",this._pageDiffs[e]=null,s.resolve(e)}))}}_updatePage(t){this._scrollMatches&&this._selected.pageIdx===t&&(this._linkService.page=t+1),this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:t})}_updateAllPages(){this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:-1})}_nextMatch(){const t=this._state.findPrevious,e=this._linkService.page-1,s=this._linkService.pagesCount;if(this._highlightMatches=!0,this._dirtyMatch){this._dirtyMatch=!1,this._selected.pageIdx=this._selected.matchIdx=-1,this._offset.pageIdx=e,this._offset.matchIdx=null,this._offset.wrapped=!1,this._resumePageIdx=null,this._pageMatches.length=0,this._pageMatchesLength.length=0,this._matchesCountTotal=0,this._updateAllPages();for(let t=0;t<s;t++)!0!==this._pendingFindMatches[t]&&(this._pendingFindMatches[t]=!0,this._extractTextPromises[t].then(t=>{delete this._pendingFindMatches[t],this._calculateMatch(t)}))}if(""===this._query)return void this._updateUIState(n.FOUND);if(this._resumePageIdx)return;const h=this._offset;if(this._pagesToSearch=s,null!==h.matchIdx){const e=this._pageMatches[h.pageIdx].length;if(!t&&h.matchIdx+1<e||t&&h.matchIdx>0)return h.matchIdx=t?h.matchIdx-1:h.matchIdx+1,void this._updateMatch(!0);this._advanceOffsetPage(t)}this._nextPageMatch()}_matchesReady(t){const e=this._offset,s=t.length,h=this._state.findPrevious;return s?(e.matchIdx=h?s-1:0,this._updateMatch(!0),!0):(this._advanceOffsetPage(h),!!(e.wrapped&&(e.matchIdx=null,this._pagesToSearch<0))&&(this._updateMatch(!1),!0))}_nextPageMatch(){null!==this._resumePageIdx&&console.error("There can only be one pending page.");let t=null;do{const e=this._offset.pageIdx;if(!(t=this._pageMatches[e])){this._resumePageIdx=e;break}}while(!this._matchesReady(t))}_advanceOffsetPage(t){const e=this._offset,s=this._linkService.pagesCount;e.pageIdx=t?e.pageIdx-1:e.pageIdx+1,e.matchIdx=null,this._pagesToSearch--,(e.pageIdx>=s||e.pageIdx<0)&&(e.pageIdx=t?s-1:0,e.wrapped=!0)}_updateMatch(t=!1){let e=n.NOT_FOUND;const s=this._offset.wrapped;if(this._offset.wrapped=!1,t){const t=this._selected.pageIdx;this._selected.pageIdx=this._offset.pageIdx,this._selected.matchIdx=this._offset.matchIdx,e=s?n.WRAPPED:n.FOUND,-1!==t&&t!==this._selected.pageIdx&&this._updatePage(t)}this._updateUIState(e,this._state.findPrevious),-1!==this._selected.pageIdx&&(this._scrollMatches=!0,this._updatePage(this._selected.pageIdx))}_onFindBarClose(t){const e=this._pdfDocument;this._firstPageCapability.promise.then(()=>{!this._pdfDocument||e&&this._pdfDocument!==e||(this._findTimeout&&(clearTimeout(this._findTimeout),this._findTimeout=null),this._resumePageIdx&&(this._resumePageIdx=null,this._dirtyMatch=!0),this._updateUIState(n.FOUND),this._highlightMatches=!1,this._updateAllPages())})}_requestMatchesCount(){const{pageIdx:t,matchIdx:e}=this._selected;let s=0,h=this._matchesCountTotal;if(-1!==e){for(let e=0;e<t;e++)s+=this._pageMatches[e]&&this._pageMatches[e].length||0;s+=e+1}return(s<1||s>h)&&(s=h=0),{current:s,total:h}}_updateUIResultsCount(){this._eventBus.dispatch("updatefindmatchescount",{source:this,matchesCount:this._requestMatchesCount()})}_updateUIState(t,e){this._eventBus.dispatch("updatefindcontrolstate",{source:this,state:t,previous:e,matchesCount:this._requestMatchesCount(),rawQuery:this._state?this._state.query:null})}}}});
//# sourceMappingURL=sourcemaps/pdf_find_controller.js.map
