/**
 * skylark-pdfjs-viewer - A version of video.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./ui_utils","./app","./viewer_compatibility"],function(t,e,n){const{CSS_UNITS:i,NullL10n:r}=t,{PDFPrintServiceFactory:o,PDFViewerApplication:a}=e,{viewerCompatibilityParams:s}=n;let c=null,h=null;function p(t,e,n,i,o=null,a){this.pdfDocument=t,this.pagesOverview=e,this.printContainer=n,this._printResolution=i||150,this._optionalContentConfigPromise=o||t.getOptionalContentConfig(),this.l10n=a||r,this.currentPage=-1,this.scratchCanvas=document.createElement("canvas")}p.prototype={layout(){this.throwIfInactive();const t=document.querySelector("body");t.setAttribute("data-pdfjsprinting",!0),this.pagesOverview.every(function(t){return t.width===this.pagesOverview[0].width&&t.height===this.pagesOverview[0].height},this)||console.warn("Not all pages have the same size. The printed result may be incorrect!"),this.pageStyleSheet=document.createElement("style");const e=this.pagesOverview[0];this.pageStyleSheet.textContent="@supports ((size:A4) and (size:1pt 1pt)) {@page { size: "+e.width+"pt "+e.height+"pt;}}",t.appendChild(this.pageStyleSheet)},destroy(){if(c!==this)return;this.printContainer.textContent="",document.querySelector("body").removeAttribute("data-pdfjsprinting"),this.pageStyleSheet&&(this.pageStyleSheet.remove(),this.pageStyleSheet=null),this.scratchCanvas.width=this.scratchCanvas.height=0,this.scratchCanvas=null,c=null,w().then(function(){"printServiceOverlay"===h.active&&h.close("printServiceOverlay")})},renderPages(){const t=this.pagesOverview.length,e=(n,r)=>{if(this.throwIfInactive(),++this.currentPage>=t)return v(t,t,this.l10n),void n();const o=this.currentPage;v(o,t,this.l10n),function(t,e,n,r,o,a){const s=c.scratchCanvas,h=o/72;s.width=Math.floor(r.width*h),s.height=Math.floor(r.height*h);const p=Math.floor(r.width*i)+"px",l=Math.floor(r.height*i)+"px",d=s.getContext("2d");return d.save(),d.fillStyle="rgb(255, 255, 255)",d.fillRect(0,0,s.width,s.height),d.restore(),e.getPage(n).then(function(t){const n={canvasContext:d,transform:[h,0,0,h,0,0],viewport:t.getViewport({scale:1,rotation:r.rotation}),intent:"print",annotationStorage:e.annotationStorage,optionalContentConfigPromise:a};return t.render(n).promise}).then(function(){return{width:p,height:l}})}(0,this.pdfDocument,o+1,this.pagesOverview[o],this._printResolution,this._optionalContentConfigPromise).then(this.useRenderedPage.bind(this)).then(function(){e(n,r)},r)};return new Promise(e)},useRenderedPage(t){this.throwIfInactive();const e=document.createElement("img");e.style.width=t.width,e.style.height=t.height;const n=this.scratchCanvas;"toBlob"in n&&!s.disableCreateObjectURL?n.toBlob(function(t){e.src=URL.createObjectURL(t)}):e.src=n.toDataURL();const i=document.createElement("div");return i.appendChild(e),this.printContainer.appendChild(i),new Promise(function(t,n){e.onload=t,e.onerror=n})},performPrint(){return this.throwIfInactive(),new Promise(t=>{setTimeout(()=>{this.active?(l.call(window),setTimeout(t,20)):t()},0)})},get active(){return this===c},throwIfInactive(){if(!this.active)throw new Error("This print request was cancelled or completed.")}};const l=window.print;function d(t){const e=document.createEvent("CustomEvent");e.initCustomEvent(t,!1,!1,"custom"),window.dispatchEvent(e)}function u(){c&&(c.destroy(),d("afterprint"))}function v(t,e,n){const i=document.getElementById("printServiceOverlay"),r=Math.round(100*t/e),o=i.querySelector("progress"),a=i.querySelector(".relative-progress");o.value=r,n.get("print_progress_percent",{progress:r},r+"%").then(t=>{a.textContent=t})}if(window.print=function(){if(c)console.warn("Ignored window.print() because of a pending print job.");else{w().then(function(){c&&h.open("printServiceOverlay")});try{d("beforeprint")}finally{if(!c)return console.error("Expected print service to be initialized."),void w().then(function(){"printServiceOverlay"===h.active&&h.close("printServiceOverlay")});const t=c;c.renderPages().then(function(){return t.performPrint()}).catch(function(){}).then(function(){t.active&&u()})}}},window.addEventListener("keydown",function(t){80!==t.keyCode||!t.ctrlKey&&!t.metaKey||t.altKey||t.shiftKey&&!window.chrome&&!window.opera||(window.print(),t.preventDefault(),t.stopImmediatePropagation?t.stopImmediatePropagation():t.stopPropagation())},!0),"onbeforeprint"in window){const t=function(t){"custom"!==t.detail&&t.stopImmediatePropagation&&t.stopImmediatePropagation()};window.addEventListener("beforeprint",t),window.addEventListener("afterprint",t)}let g;function w(){if(!g){if(!(h=a.overlayManager))throw new Error("The overlay manager has not yet been initialized.");g=h.register("printServiceOverlay",document.getElementById("printServiceOverlay"),u,!0),document.getElementById("printCancel").onclick=u}return g}return o.instance={supportsPrinting:!0,createPrintService(t,e,n,i,r,o){if(c)throw new Error("The print service is created and active.");return c=new p(t,e,n,i,r,o)}},{PDFPrintService:p}});
//# sourceMappingURL=sourcemaps/pdf_print_service.js.map
